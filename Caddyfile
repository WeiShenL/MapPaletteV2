# Caddyfile for MapPaletteV2
# Auto HTTPS with Let's Encrypt

{
  email admin@{$DOMAIN}
}

# Development - HTTP only
:80 {
  # Frontend
  handle /* {
    reverse_proxy frontend:80
  }

  # API Gateway
  handle /api/* {
    reverse_proxy feed-service:5000
  }

  # Supabase Kong Gateway
  handle /auth/* {
    reverse_proxy supabase-kong:8000
  }

  handle /rest/* {
    reverse_proxy supabase-kong:8000
  }

  # Compression
  encode gzip zstd

  # Security headers
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
  }

  # CORS
  @options method OPTIONS
  handle @options {
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization"
    respond 204
  }
}

# Production - with domain
{$DOMAIN:localhost} {
  # Frontend
  handle /* {
    reverse_proxy frontend:80
  }

  # API Gateway
  handle /api/* {
    reverse_proxy feed-service:5000
  }

  # Supabase
  handle /auth/* {
    reverse_proxy supabase-kong:8000
  }

  handle /rest/* {
    reverse_proxy supabase-kong:8000
  }

  # Compression
  encode gzip zstd

  # Security headers
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    X-XSS-Protection "1; mode=block"
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Referrer-Policy "strict-origin-when-cross-origin"
  }

  # Logs
  log {
    output file /var/log/caddy/access.log
  }
}
