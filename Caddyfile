# Caddyfile for MapPaletteV2
# Auto HTTPS with Let's Encrypt
# Version: 2.1

{
  email admin@{$DOMAIN:example.com}
  # Enable admin API for monitoring
  admin :2019
}

# Reusable reverse proxy snippet for API services
(api_proxy) {
  header_up X-Real-IP {remote_host}
  header_up X-Forwarded-For {remote_host}
  header_up X-Forwarded-Proto {scheme}
  header_up X-Forwarded-Host {host}
  # Reduce health check frequency for dev (30s instead of 10s)
  health_interval 30s
  health_timeout 5s
  # Keep connections alive for better performance
  transport http {
    keepalive 30s
    keepalive_idle_conns 10
  }
}

# Global options for rate limiting
(common) {
  # Compression
  encode gzip zstd

  # Security headers
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    # Remove server header for security
    -Server
  }

  # Health check endpoint (doesn't require auth)
  handle /health {
    respond "OK" 200
  }
}

# Fallback for port 80 (redirect to HTTPS for production domains only)
:80 {
  import common

  @not_localhost host !localhost
  handle @not_localhost {
    redir https://{host}{uri} 308
  }

  # If we get here and it's localhost, handle normally (same as localhost block below)
  # CORS is handled by individual services - Caddy only forwards requests

  # API Routes - Microservices
  # User Service (port 5000)
  handle /api/users/* {
    reverse_proxy user-service:5000 {
      import api_proxy
      health_uri /health
      # Longer timeouts for file uploads
      transport http {
        read_timeout 60s
        write_timeout 60s
        keepalive 30s
      }
    }
  }

  # Post Service (port 5000)
  handle /api/posts/* {
    reverse_proxy post-service:5000 {
      import api_proxy
      health_uri /health
    }
  }

  # Interaction Service (port 5000)
  handle /api/interactions/* {
    reverse_proxy interaction-service:5000 {
      import api_proxy
      health_uri /health
    }
  }

  # Follow Service (port 5000)
  handle /api/follow/* {
    reverse_proxy follow-service:5000 {
      import api_proxy
      health_uri /health
    }
  }

  # Feed Service (port 5000)
  handle /api/feed/* {
    reverse_proxy feed-service:5000 {
      import api_proxy
      health_uri /health
    }
  }

  # Profile Service (port 5000)
  handle /api/profile/* {
    reverse_proxy profile-service:5000 {
      import api_proxy
      health_uri /health
    }
  }

  # Leaderboard Service (Go - port 8080)
  handle /api/leaderboard/* {
    reverse_proxy leaderboard-service:8080 {
      import api_proxy
      health_uri /health
    }
  }

  # User Discovery Service (port 3010)
  handle /api/discover/* {
    reverse_proxy user-discovery-service:3010 {
      import api_proxy
      health_uri /actuator/health
    }
  }

  # Social Interaction Service (port 5000)
  handle /api/social/* {
    reverse_proxy social-interaction-service:5000 {
      import api_proxy
      health_uri /health
    }
  }

  # Explore Routes Service (Node.js - port 5000)
  handle /api/explore/* {
    reverse_proxy explore-routes-service:5000 {
      import api_proxy
      health_uri /health
    }
  }

  handle /auth/* {
    # Handle OPTIONS preflight requests for CORS
    @auth_options method OPTIONS
    handle @auth_options {
      header Access-Control-Allow-Origin "*"
      header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
      header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, X-Auth-Token, X-Client-Info, X-Requested-With, apikey, x-client-info, x-supabase-api-version"
      header Access-Control-Max-Age "3600"
      header Access-Control-Allow-Credentials "true"
      respond 204
    }

    # Explicitly add CORS headers for /auth/* requests
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, X-Auth-Token, X-Client-Info, X-Requested-With, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Expose-Headers "Authorization, Content-Type, X-Request-Id, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Max-Age "3600"
    header Access-Control-Allow-Credentials "true"

    reverse_proxy supabase-kong:8000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  handle /rest/* {
    # Handle OPTIONS preflight requests for CORS
    @rest_options method OPTIONS
    handle @rest_options {
      header Access-Control-Allow-Origin "*"
      header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
      header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, Prefer, Range, apikey, x-client-info, x-supabase-api-version"
      header Access-Control-Max-Age "3600"
      header Access-Control-Allow-Credentials "true"
      respond 204
    }

    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, Prefer, Range, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Expose-Headers "Authorization, Content-Range, Content-Type, X-Request-Id, apikey"
    header Access-Control-Max-Age "3600"
    header Access-Control-Allow-Credentials "true"

    reverse_proxy supabase-kong:8000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  handle /storage/* {
    # Handle OPTIONS preflight requests for CORS
    @storage_options method OPTIONS
    handle @storage_options {
      header Access-Control-Allow-Origin "*"
      header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
      header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, Range, X-Upsert, apikey, x-client-info, x-supabase-api-version"
      header Access-Control-Max-Age "3600"
      header Access-Control-Allow-Credentials "true"
      respond 204
    }

    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, Range, X-Upsert, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Expose-Headers "Authorization, Content-Length, Content-Range, Content-Type, ETag, X-Request-Id, apikey"
    header Access-Control-Max-Age "3600"
    header Access-Control-Allow-Credentials "true"

    reverse_proxy supabase-kong:8000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  # Frontend (SPA) - must be last
  handle /* {
    reverse_proxy frontend:80 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  # Error handling
  handle_errors {
    @5xx expression `{err.status_code} >= 500 && {err.status_code} < 600`
    handle @5xx {
      respond "Service temporarily unavailable" 503
    }

    @4xx expression `{err.status_code} >= 400 && {err.status_code} < 500`
    handle @4xx {
      respond "Bad request" {err.status_code}
    }
  }

  # Logging
  log {
    output file /var/log/caddy/access.log {
      roll_size 100mb
      roll_keep 5
      roll_keep_for 720h
    }
    format json
    level INFO
  }
}

# Production - with domain and HTTPS (only active when DOMAIN is explicitly set)
https://{$DOMAIN} {
  import common

  # Additional production security headers
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' {$DOMAIN}"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
  }

  # CORS handling for all API requests
  @cors_options method OPTIONS
  handle @cors_options {
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, X-Auth-Token, X-Client-Info, X-Requested-With, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Max-Age "3600"
    header Access-Control-Allow-Credentials "true"
    respond 204
  }

  # Apply CORS headers to all API responses
  header /api/* {
    Access-Control-Allow-Origin "*"
    Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
    Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, X-Auth-Token, X-Client-Info, X-Requested-With, apikey, x-client-info, x-supabase-api-version"
    Access-Control-Max-Age "3600"
  }

  # API Routes - same as development but with HTTPS
  # User Service
  handle /api/users/* {
    reverse_proxy user-service:5000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      health_uri /health
      health_interval 10s
      health_timeout 5s
      fail_duration 30s
      max_fails 3
    }
  }

  # Post Service
  handle /api/posts/* {
    reverse_proxy post-service:5000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      health_uri /health
      health_interval 10s
      health_timeout 5s
      fail_duration 30s
      max_fails 3
    }
  }

  # Interaction Service
  handle /api/interactions/* {
    reverse_proxy interaction-service:5000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      health_uri /health
      health_interval 10s
      health_timeout 5s
      fail_duration 30s
      max_fails 3
    }
  }

  # Follow Service
  handle /api/follow/* {
    reverse_proxy follow-service:5000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      health_uri /health
      health_interval 10s
      health_timeout 5s
      fail_duration 30s
      max_fails 3
    }
  }

  # Feed Service
  handle /api/feed/* {
    reverse_proxy feed-service:5000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      health_uri /health
      health_interval 10s
      health_timeout 5s
      fail_duration 30s
      max_fails 3
    }
  }

  # Profile Service
  handle /api/profile/* {
    reverse_proxy profile-service:5000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      health_uri /health
      health_interval 10s
      health_timeout 5s
      fail_duration 30s
      max_fails 3
    }
  }

  # Leaderboard Service (Go - port 8080)
  handle /api/leaderboard/* {
    reverse_proxy leaderboard-service:8080 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
      health_uri /health
      health_interval 10s
      health_timeout 5s
      fail_duration 30s
      max_fails 3
    }
  }

  # Supabase Kong Gateway
  handle /auth/* {
    # Handle OPTIONS preflight requests for CORS
    @auth_options_prod method OPTIONS
    handle @auth_options_prod {
      header Access-Control-Allow-Origin "*"
      header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
      header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, X-Auth-Token, X-Client-Info, X-Requested-With, apikey, x-client-info, x-supabase-api-version"
      header Access-Control-Max-Age "3600"
      header Access-Control-Allow-Credentials "true"
      respond 204
    }

    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, X-Auth-Token, X-Client-Info, X-Requested-With, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Expose-Headers "Authorization, Content-Type, X-Request-Id, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Max-Age "3600"
    header Access-Control-Allow-Credentials "true"

    reverse_proxy supabase-kong:8000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  handle /rest/* {
    # Handle OPTIONS preflight requests for CORS
    @rest_options_prod method OPTIONS
    handle @rest_options_prod {
      header Access-Control-Allow-Origin "*"
      header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
      header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, Prefer, Range, apikey, x-client-info, x-supabase-api-version"
      header Access-Control-Max-Age "3600"
      header Access-Control-Allow-Credentials "true"
      respond 204
    }

    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, Prefer, Range, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Expose-Headers "Authorization, Content-Range, Content-Type, X-Request-Id, apikey"
    header Access-Control-Max-Age "3600"
    header Access-Control-Allow-Credentials "true"

    reverse_proxy supabase-kong:8000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  handle /storage/* {
    # Handle OPTIONS preflight requests for CORS
    @storage_options_prod method OPTIONS
    handle @storage_options_prod {
      header Access-Control-Allow-Origin "*"
      header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
      header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, Range, X-Upsert, apikey, x-client-info, x-supabase-api-version"
      header Access-Control-Max-Age "3600"
      header Access-Control-Allow-Credentials "true"
      respond 204
    }

    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, HEAD, PUT, PATCH, POST, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Accept, Accept-Version, Authorization, Content-Length, Content-Type, Date, Origin, Range, X-Upsert, apikey, x-client-info, x-supabase-api-version"
    header Access-Control-Expose-Headers "Authorization, Content-Length, Content-Range, Content-Type, ETag, X-Request-Id, apikey"
    header Access-Control-Max-Age "3600"
    header Access-Control-Allow-Credentials "true"

    reverse_proxy supabase-kong:8000 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  # Frontend (SPA)
  handle /* {
    reverse_proxy frontend:80 {
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  # Error handling
  handle_errors {
    @5xx expression `{err.status_code} >= 500 && {err.status_code} < 600`
    handle @5xx {
      respond "Service temporarily unavailable" 503
    }

    @4xx expression `{err.status_code} >= 400 && {err.status_code} < 500`
    handle @4xx {
      respond "Bad request" {err.status_code}
    }
  }

  # Production logging with more detail
  log {
    output file /var/log/caddy/access.log {
      roll_size 100mb
      roll_keep 10
      roll_keep_for 720h
    }
    format json
    level INFO
  }

  # Separate error log
  log {
    output file /var/log/caddy/error.log {
      roll_size 50mb
      roll_keep 5
      roll_keep_for 720h
    }
    level ERROR
  }
}
